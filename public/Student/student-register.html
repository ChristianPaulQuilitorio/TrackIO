<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Register</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="student-style.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="form-container" id="form-container">
    <div id="register-form-container">
      <h2>Student Register</h2>
      <form id="completeProfileForm">
        <input type="email" id="rEmail" readonly />
        <input type="text" id="rFirstName" placeholder="First Name" required />
        <input type="text" id="rLastName" placeholder="Last Name" required />
        <input type="password" id="rPassword" placeholder="New Password" required />
        <input type="password" id="rConfirmPassword" placeholder="Confirm Password" required />
        <button type="submit" id="submitCompleteProfile">Complete Registration</button>
        <div id="registerMessage"></div>
      </form>
      <div class="toggle-link">
        <p>Already have an account? <a href="student-login.html">Login</a></p>
      </div>
    </div>
  </div>

  <!-- Firebase Setup -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyC9z8Amm-vlNcbw-XqEnrkt_WpWHaGfwtQ",
      authDomain: "trackio-f5b07.firebaseapp.com",
      projectId: "trackio-f5b07",
      storageBucket: "trackio-f5b07.appspot.com",
      messagingSenderId: "1083789426923",
      appId: "1:1083789426923:web:c372749a28e84ff9cd7eae"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
  
    const emailField = document.getElementById('rEmail');
    const firstNameField = document.getElementById('rFirstName');
    const lastNameField = document.getElementById('rLastName');
    const passwordField = document.getElementById('rPassword');
    const confirmPasswordField = document.getElementById('rConfirmPassword');
    const messageDiv = document.getElementById('registerMessage');
    const submitBtn = document.getElementById('submitCompleteProfile');
  
    // Prefill form fields if email, first name, and last name exist in localStorage
    if (localStorage.getItem("pendingVerificationEmail")) {
        const email = localStorage.getItem("pendingVerificationEmail");
        const firstName = localStorage.getItem("tempFirstName");
        const lastName = localStorage.getItem("tempLastName");

        emailField.value = email;
        firstNameField.value = firstName;
        lastNameField.value = lastName;
    }

    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
  
      const firstName = firstNameField.value.trim();
      const lastName = lastNameField.value.trim();
      const newPassword = passwordField.value;
      const confirmPassword = confirmPasswordField.value;
  
      if (!firstName || !lastName || !newPassword || !confirmPassword) {
        messageDiv.textContent = "Please fill in all fields.";
        return;
      }
  
      if (newPassword !== confirmPassword) {
        messageDiv.textContent = "Passwords do not match.";
        return;
      }
  
      const user = auth.currentUser;
      if (!user || !user.emailVerified) {
        messageDiv.textContent = "You must be verified to register.";
        return;
      }
  
      try {
        await updatePassword(user, newPassword); // update Firebase password
  
        const email = user.email;
        const uid = user.uid;
  
        // Send data to backend
        const response = await fetch("../../PHP/save-student-profile.php", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            uid,
            email,
            firstName,
            lastName
          })
        });
  
        const result = await response.json();
  
        if (result.status === "success") {
          messageDiv.textContent = "Registration completed successfully! ðŸŽ‰";
          localStorage.removeItem("pendingVerificationEmail");
          setTimeout(() => {
            window.location.href = "student-dashboard.html"; // change as needed
          }, 2000);
        } else {
          messageDiv.textContent = "Error saving to database: " + result.message;
        }
  
      } catch (err) {
        console.error(err);
        messageDiv.textContent = "Something went wrong. Try again.";
      }
    });
  </script>
  
</body>
</html>
